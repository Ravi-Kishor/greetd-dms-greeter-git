name: Build greetd-dms-greeter-git (x86-64-v3)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: archlinux:latest

    steps:
      - name: Install base-devel and git
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git sudo

      - name: Create build user
        run: |
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure makepkg for x86-64-v3 + strip
        run: |
          cat >> /etc/makepkg.conf << "EOF"

          CARCH="x86_64"
          CHOST="x86_64-pc-linux-gnu"

          CFLAGS="-march=x86-64-v3 -O2 -pipe -fno-plt"
          CXXFLAGS="${CFLAGS}"
          RUSTFLAGS="-C target-cpu=x86-64-v3"
          LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"

          OPTIONS=(strip docs !libtool !staticlibs emptydirs zipman purge !debug lto)
          STRIP_BINARIES="--strip-all"
          STRIP_SHARED="--strip-unneeded"
          STRIP_STATIC="--strip-debug"
          EOF

      - name: Fix permissions
        run: chown -R builduser:builduser $GITHUB_WORKSPACE

      - name: Build package
        run: |
          su builduser -c "cd $GITHUB_WORKSPACE && makepkg -s --noconfirm"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: greetd-dms-greeter-git-x86-64-v3
          path: "*.pkg.tar.zst"
