#!/bin/bash
set -euo pipefail

REPO="Ravi-Kishor/greetd-dms-greeter-git"
PKG_NAME="greetd-dms-greeter-git"

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "‚ùå Required command '$1' not found"
    exit 1
  }
}

require aria2c
require curl
require jq
require sudo
require pacman
require grep

cpu_supports_v3() {
  grep -qiE 'avx2' /proc/cpuinfo
}

get_installed_version() {
  pacman -Q "$PKG_NAME" 2>/dev/null | awk '{print $2}' || echo "Not Installed"
}

INSTALLED_VERSION=$(get_installed_version)

echo "Installed version: $INSTALLED_VERSION"
echo "üì° Fetching latest release metadata..."

RELEASE_JSON=$(curl -fsSL "https://api.github.com/repos/$REPO/releases/latest")

TAG_NAME=$(echo "$RELEASE_JSON" | jq -r '.tag_name')

if [[ -z "$TAG_NAME" || "$TAG_NAME" == "null" ]]; then
  echo "‚ùå Failed to fetch release information"
  exit 1
fi

echo "Latest release tag: $TAG_NAME"

# Determine which build to prefer
if cpu_supports_v3; then
  echo "üß† AVX2 detected ‚Äî preferring x86_64_v3 build"
  ASSET_PATTERN="^greetd-dms-greeter-git-.*-x86_64_v3\.pkg\.tar\.zst$"
else
  echo "‚ö†Ô∏è  AVX2 not detected ‚Äî using generic x86_64 build"
  ASSET_PATTERN="^greetd-dms-greeter-git-.*-x86_64\.pkg\.tar\.zst$"
fi

ASSET_URL=$(echo "$RELEASE_JSON" | jq -r \
  --arg pattern "$ASSET_PATTERN" '
  .assets[]
  | select(.name | test($pattern))
  | .browser_download_url
' | head -n1)

if [[ -z "$ASSET_URL" || "$ASSET_URL" == "null" ]]; then
  echo "‚ùå Could not find matching package in release $TAG_NAME"
  exit 1
fi

PKG_FILE=$(basename "$ASSET_URL")

LATEST_VERSION=$(echo "$PKG_FILE" | sed -E \
  's/^greetd-dms-greeter-git-(.*)-x86_64(_v3)?\.pkg\.tar\.zst/\1/')

echo "Latest package version: $LATEST_VERSION"
echo

echo "Choose an action:"
echo "1) Update (skip if already latest)"
echo "2) Force install"
read -rp "Enter choice (1/2): " CHOICE

if [[ "$CHOICE" == "1" ]]; then
  if [[ "$INSTALLED_VERSION" == "$LATEST_VERSION" ]]; then
    echo "‚úÖ Already up to date"
    exit 0
  fi
  echo "‚¨ÜÔ∏è Updating $INSTALLED_VERSION ‚Üí $LATEST_VERSION"
elif [[ "$CHOICE" == "2" ]]; then
  echo "üõ†Ô∏è Force installing $LATEST_VERSION"
else
  echo "‚ùå Invalid choice"
  exit 1
fi

TMP_DIR=$(mktemp -d)
cd "$TMP_DIR"

echo
echo "üì• Downloading package..."
echo "   $PKG_FILE"

aria2c -x 8 -s 8 -k 1M -o "$PKG_FILE" "$ASSET_URL"

echo
echo "üì¶ Installing package..."
sudo pacman -U --noconfirm "$PKG_FILE"

cd /
rm -rf "$TMP_DIR"

echo
echo "‚úÖ greetd-dms-greeter-git $LATEST_VERSION installed successfully!"
